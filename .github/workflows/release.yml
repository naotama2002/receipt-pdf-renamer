name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  FRONTEND_DIR: frontend

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: true
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          package_json_file: ${{ env.FRONTEND_DIR }}/package.json
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .tool-versions
          cache: pnpm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/pnpm-lock.yaml

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Build macOS (Universal Binary)
        run: make release-mac

      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          hdiutil create -volname "Receipt PDF Renamer" -srcfolder "build/bin/Receipt PDF Renamer.app" -ov -format UDZO "Receipt-PDF-Renamer-${VERSION}-mac.dmg"

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: macos-dmg
          path: Receipt-PDF-Renamer-*.dmg
          retention-days: 1

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache: true
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          package_json_file: ${{ env.FRONTEND_DIR }}/package.json
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .tool-versions
          cache: pnpm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/pnpm-lock.yaml

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Build Windows
        run: make release-win

      - name: Create ZIP
        shell: pwsh
        run: |
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/', ''
          $ZIP_NAME = "receipt-pdf-renamer-${VERSION}-win.zip"

          New-Item -ItemType Directory -Force -Path "release-win"
          Copy-Item "build/bin/receipt-pdf-renamer.exe" "release-win/"
          Copy-Item "build/windows/context-menu-install.reg" "release-win/"
          Copy-Item "build/windows/context-menu-uninstall.reg" "release-win/"

          @"
          Receipt PDF Renamer for Windows

          Installation:
          1. Copy receipt-pdf-renamer.exe to your preferred location
          2. (Optional) Edit context-menu-install.reg to set the correct path, then double-click to register
          "@ | Out-File -FilePath "release-win/README.txt" -Encoding UTF8

          Compress-Archive -Path "release-win/*" -DestinationPath $ZIP_NAME

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: windows-zip
          path: receipt-pdf-renamer-*.zip
          retention-days: 1

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: macos-dmg
          path: artifacts

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: windows-zip
          path: artifacts

      - run: ls -la artifacts/

      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
